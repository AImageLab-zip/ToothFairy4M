{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if is_own_profile %}
        My Profile
    {% else %}
        {{ target_user.username }}'s Profile
    {% endif %}
    - ToothFairy4M
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2>
                        <i class="fas fa-user-circle me-2"></i>
                        {% if is_own_profile %}
                            My Profile
                        {% else %}
                            {{ target_user.username }}'s Profile
                        {% endif %}
                    </h2>
                    <p class="text-muted mb-0">
                        <span class="badge bg-secondary">{{ target_user.profile.get_role_display }}</span>
                        {% if is_viewing_other_profile %}
                            <span class="badge bg-info ms-2">Viewing Other Profile</span>
                        {% endif %}
                    </p>
                </div>
                {% firstof request.resolver_match.namespace 'maxillo' as ns %}
                <a href="{% url ns|add:':patient_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Back to Scans
                </a>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <!-- Patients Uploaded -->
        <div class="col-md-4 mb-3">
            <div class="card h-100 border-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-subtitle mb-2 text-muted">
                                <i class="fas fa-upload me-1"></i>Patients Uploaded
                            </h6>
                            <h2 class="card-title mb-0 text-primary">{{ total_patients_uploaded }}</h2>
                        </div>
                        <div class="text-end">
                            <i class="fas fa-upload fa-3x text-primary opacity-25"></i>
                        </div>
                    </div>
                    <hr>
                    <small class="text-muted">
                        <i class="fas fa-calendar-week me-1"></i>Last 7 days: 
                        <strong>{{ uploads_last_7_days }}</strong>
                    </small>
                </div>
            </div>
        </div>

        <!-- Bite Classifications -->
        <div class="col-md-4 mb-3">
            <div class="card h-100 border-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-subtitle mb-2 text-muted">
                                <i class="fas fa-clipboard-check me-1"></i>Bite Classifications
                            </h6>
                            <h2 class="card-title mb-0 text-success">{{ total_classifications }}</h2>
                        </div>
                        <div class="text-end">
                            <i class="fas fa-clipboard-check fa-3x text-success opacity-25"></i>
                        </div>
                    </div>
                    <hr>
                    <small class="text-muted">
                        <i class="fas fa-users me-1"></i>Unique patients: 
                        <strong>{{ unique_patients_annotated }}</strong>
                        <br>
                        <i class="fas fa-calendar-week me-1"></i>Last 7 days: 
                        <strong>{{ classifications_last_7_days }}</strong>
                    </small>
                </div>
            </div>
        </div>

        <!-- Voice Captions -->
        <div class="col-md-4 mb-3">
            <div class="card h-100 border-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-subtitle mb-2 text-muted">
                                <i class="fas fa-microphone me-1"></i>Voice Captions
                            </h6>
                            <h2 class="card-title mb-0 text-info">{{ total_voice_captions }}</h2>
                        </div>
                        <div class="text-end">
                            <i class="fas fa-microphone fa-3x text-info opacity-25"></i>
                        </div>
                    </div>
                    <hr>
                    <small class="text-muted">
                        <i class="fas fa-calendar-week me-1"></i>Last 7 days: 
                        <strong>{{ voice_captions_last_7_days }}</strong>
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Last Activity -->
    {% if last_activity %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-light border">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        {% if last_activity_type == 'upload' %}
                            <i class="fas fa-upload fa-2x text-primary"></i>
                        {% elif last_activity_type == 'classification' %}
                            <i class="fas fa-clipboard-check fa-2x text-success"></i>
                        {% elif last_activity_type == 'voice_caption' %}
                            <i class="fas fa-microphone fa-2x text-info"></i>
                        {% endif %}
                    </div>
                    <div>
                        <h6 class="mb-1">Last Activity</h6>
                        <p class="mb-0 text-muted">
                            {% if last_activity_type == 'upload' %}
                                Uploaded a patient
                            {% elif last_activity_type == 'classification' %}
                                Made a bite classification
                            {% elif last_activity_type == 'voice_caption' %}
                                Recorded a voice caption
                            {% endif %}
                            <strong>{{ last_activity|timesince }} ago</strong>
                            <span class="text-muted">({{ last_activity|date:"Y-m-d H:i" }})</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Activity Tables -->
    <div class="row">
        <!-- Recent Bite Classifications -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-clipboard-check me-2"></i>Recent Bite Classifications
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if recent_classifications %}
                        <div class="table-responsive">
                            <table class="table table-hover table-sm mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Patient</th>
                                        <th>Date & Time</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for classification in recent_classifications %}
                                    <tr>
                                        <td>
                                            <i class="fas fa-tooth text-muted me-1"></i>
                                            <strong>{{ classification.patient.name }}</strong>
                                            <br>
                                            <small class="text-muted">ID: {{ classification.patient.patient_id }}</small>
                                        </td>
                                        <td>
                                            <span class="text-nowrap">{{ classification.timestamp|date:"Y-m-d" }}</span>
                                            <br>
                                            <small class="text-muted">{{ classification.timestamp|date:"H:i" }}</small>
                                            <br>
                                            <small class="text-muted">({{ classification.timestamp|timesince }} ago)</small>
                                        </td>
                                        <td>
                                            {% firstof request.resolver_match.namespace 'maxillo' as ns %}
                                            <a href="{% url ns|add:':patient_detail' classification.patient.patient_id %}" 
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye me-1"></i>View
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="p-4 text-center text-muted">
                            <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                            <p class="mb-0">No bite classifications yet</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Recent Voice Captions -->
        <div class="col-lg-6 mb-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-microphone me-2"></i>Recent Voice Captions
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if recent_voice_captions %}
                        <div class="table-responsive">
                            <table class="table table-hover table-sm mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Patient</th>
                                        <th>Date & Time</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for caption in recent_voice_captions %}
                                    <tr>
                                        <td>
                                            {% if caption.patient %}
                                                <i class="fas fa-tooth text-muted me-1"></i>
                                                <strong>{{ caption.patient.name }}</strong>
                                                <br>
                                                <small class="text-muted">ID: {{ caption.patient.patient_id }}</small>
                                            {% else %}
                                                <span class="text-muted">No patient</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="text-nowrap">{{ caption.created_at|date:"Y-m-d" }}</span>
                                            <br>
                                            <small class="text-muted">{{ caption.created_at|date:"H:i" }}</small>
                                            <br>
                                            <small class="text-muted">({{ caption.created_at|timesince }} ago)</small>
                                        </td>
                                        <td>
                                            {% if caption.patient %}
                                                {% firstof request.resolver_match.namespace 'maxillo' as ns %}
                                                <a href="{% url ns|add:':patient_detail' caption.patient.patient_id %}" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye me-1"></i>View
                                                </a>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="p-4 text-center text-muted">
                            <i class="fas fa-microphone-slash fa-2x mb-2"></i>
                            <p class="mb-0">No voice captions yet</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Uploads -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-upload me-2"></i>Recent Patient Uploads
                    </h5>
                </div>
                <div class="card-body p-0">
                    {% if recent_uploads %}
                        <div class="table-responsive">
                            <table class="table table-hover table-sm mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Patient</th>
                                        <th>Project</th>
                                        <th>Visibility</th>
                                        <th>Date & Time</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for patient in recent_uploads %}
                                    <tr>
                                        <td>
                                            <i class="fas fa-tooth text-muted me-1"></i>
                                            <strong>{{ patient.name }}</strong>
                                            <br>
                                            <small class="text-muted">ID: {{ patient.patient_id }}</small>
                                        </td>
                                        <td>
                                            {% if patient.project %}
                                                <span class="badge bg-secondary">{{ patient.project.name }}</span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if patient.visibility == 'public' %}
                                                <span class="badge bg-success">Public</span>
                                            {% elif patient.visibility == 'private' %}
                                                <span class="badge bg-warning">Private</span>
                                            {% elif patient.visibility == 'debug' %}
                                                <span class="badge bg-info">Debug</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="text-nowrap">{{ patient.uploaded_at|date:"Y-m-d" }}</span>
                                            <br>
                                            <small class="text-muted">{{ patient.uploaded_at|date:"H:i" }}</small>
                                            <br>
                                            <small class="text-muted">({{ patient.uploaded_at|timesince }} ago)</small>
                                        </td>
                                        <td>
                                            {% firstof request.resolver_match.namespace 'maxillo' as ns %}
                                            <a href="{% url ns|add:':patient_detail' patient.patient_id %}" 
                                               class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-eye me-1"></i>View
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="p-4 text-center text-muted">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <p class="mb-0">No patients uploaded yet</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- View Other Users Section (Admin & Project Manager) -->
    {% if user.profile.can_view_other_profiles and is_own_profile %}
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card border-warning">
                <div class="card-header bg-warning">
                    <h5 class="mb-0">
                        <i class="fas fa-users-cog me-2"></i>View Other Users
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">You can view the profile of any user in the system.</p>
                    <form method="get" action="{% url 'maxillo:user_profile_by_username' 'PLACEHOLDER' %}" class="row g-3" id="userSelectForm">
                        <div class="col-auto">
                            <select class="form-select" id="userSelect" name="username">
                                <option value="">Select a user...</option>
                                {% for user_obj in all_users %}
                                    <option value="{{ user_obj.username }}">
                                        {{ user_obj.username }} ({{ user_obj.profile.get_role_display }})
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-auto">
                            <button type="button" class="btn btn-primary" onclick="viewUserProfile()">
                                <i class="fas fa-eye me-1"></i>View Profile
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
function viewUserProfile() {
    const select = document.getElementById('userSelect');
    const username = select.value;
    if (username) {
        {% firstof request.resolver_match.namespace 'maxillo' as ns %}
        window.location.href = "{% url 'maxillo:user_profile_by_username' 'PLACEHOLDER' %}".replace('PLACEHOLDER', username);
    } else {
        alert('Please select a user.');
    }
}
</script>

<style>
.opacity-25 {
    opacity: 0.25;
}
</style>
{% endblock %}

