<!-- NIFTI Metadata Section -->
{% if scan_pair.has_cbct_scan %}
<div class="card mb-3 collapsible-section">
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center" 
         data-bs-toggle="collapse" 
         data-bs-target="#niftiMetadataCollapse" 
         style="cursor: pointer;">
        <h5 class="mb-0">
            <i class="fas fa-info-circle me-2"></i>NIFTI Metadata
        </h5>
        <i class="fas fa-chevron-down collapse-icon"></i>
    </div>
    <div id="niftiMetadataCollapse" class="collapse">
        <div class="card-body">
            <div id="niftiMetadataContent">
                <div class="text-center p-3">
                    <i class="fas fa-spinner fa-spin"></i> Loading metadata...
                </div>
            </div>
            
            <!-- Metadata Display Template -->
            <div id="niftiMetadataDisplay" style="display: none;">
                <div class="metadata-section mb-3">
                    <h6 class="text-primary mb-2">Basic Information</h6>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">Orientation:</small>
                            <div class="fw-bold" id="niftiOrientation"></div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Data Type:</small>
                            <div class="fw-bold" id="niftiDataType"></div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <small class="text-muted">Shape (X, Y, Z):</small>
                            <div class="fw-bold" id="niftiShape"></div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-12">
                            <small class="text-muted">Voxel Dimensions (mm):</small>
                            <div class="fw-bold" id="niftiVoxelDims"></div>
                        </div>
                    </div>
                </div>
                
                <div class="metadata-section mb-3">
                    <h6 class="text-primary mb-2">
                        Origin (mm)
                        {% if user_profile.is_admin %}
                        <button class="btn btn-sm btn-outline-primary float-end" onclick="editOrigin()">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        {% endif %}
                    </h6>
                    <div id="originDisplay" class="font-monospace">
                        <div>X: <span id="originX"></span></div>
                        <div>Y: <span id="originY"></span></div>
                        <div>Z: <span id="originZ"></span></div>
                    </div>
                    <div id="originEdit" style="display: none;">
                        <div class="input-group input-group-sm mb-1">
                            <span class="input-group-text">X</span>
                            <input type="number" class="form-control" id="originXInput" step="0.001">
                        </div>
                        <div class="input-group input-group-sm mb-1">
                            <span class="input-group-text">Y</span>
                            <input type="number" class="form-control" id="originYInput" step="0.001">
                        </div>
                        <div class="input-group input-group-sm mb-2">
                            <span class="input-group-text">Z</span>
                            <input type="number" class="form-control" id="originZInput" step="0.001">
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-success" onclick="saveOrigin()">Save</button>
                            <button class="btn btn-secondary" onclick="cancelOriginEdit()">Cancel</button>
                        </div>
                    </div>
                </div>
                
                <div class="metadata-section">
                    <h6 class="text-primary mb-2">
                        Affine Matrix
                        {% if user_profile.is_admin %}
                        <button class="btn btn-sm btn-outline-primary float-end" onclick="editAffine()">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        {% endif %}
                    </h6>
                    <div id="affineDisplay" class="font-monospace small">
                        <table class="table table-sm table-bordered">
                            <tbody id="affineTable">
                            </tbody>
                        </table>
                    </div>
                    <div id="affineEdit" style="display: none;">
                        <div class="alert alert-warning small">
                            <i class="fas fa-exclamation-triangle"></i> 
                            Editing the affine matrix directly can significantly alter the spatial orientation. 
                            Make sure you understand the implications.
                        </div>
                        <div id="affineEditTable"></div>
                        <div class="btn-group btn-group-sm mt-2">
                            <button class="btn btn-success" onclick="saveAffine()">Save</button>
                            <button class="btn btn-secondary" onclick="cancelAffineEdit()">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Error Display -->
            <div id="niftiMetadataError" class="alert alert-danger" style="display: none;">
                <i class="fas fa-exclamation-circle"></i> 
                <span id="niftiErrorMessage"></span>
            </div>
        </div>
    </div>
</div>

<style>
.metadata-section {
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
}

#affineTable td {
    text-align: right;
    padding: 2px 8px;
}

.affine-input {
    width: 80px;
    text-align: right;
}
</style>
{% endif %}