version: '3.8'

services:
  # Django web application
  webapp:
    build: .
    ports:
      - "8000:8000"
    volumes:
      - ./dataset:/dataset  # Bind mount dataset directory from host
      - .:/app
    environment:
      - DEBUG=1
    depends_on:
      - db
      - dataset-init
  
  # Database
  db:
    image: postgres:15
    environment:
      POSTGRES_DB: toothfairy
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  # Initialize dataset directory structure
  dataset-init:
    image: alpine:latest
    volumes:
      - ./dataset:/dataset
    command: >
      sh -c "
        echo 'Creating dataset directory structure...'
        mkdir -p /dataset/raw/cbct
        mkdir -p /dataset/raw/ios
        mkdir -p /dataset/raw/audio
        mkdir -p /dataset/processed/cbct
        mkdir -p /dataset/processed/ios
        mkdir -p /dataset/processed/audio
        chmod -R 755 /dataset
        echo 'Dataset directory structure created successfully!'
        ls -la /dataset/
      "

  # CBCT Processing Container
  cbct-processor:
    image: your-cbct-processor:latest
    volumes:
      - ./dataset:/dataset  # Same bind mount as webapp
    environment:
      - WEBAPP_BASE_URL=http://webapp:8000
      - WORKER_ID=cbct-worker-1
      - JOB_TYPE=cbct
      - POLL_INTERVAL=60
    depends_on:
      - webapp
      - dataset-init
    restart: unless-stopped
    command: python /app/docker_integration_example.py --job-type cbct --worker-id cbct-worker-1
    # Alternative: use your existing polling script
    # command: your-existing-cbct-polling-script.py

  # IOS Processing Container  
  ios-processor:
    image: your-ios-processor:latest
    volumes:
      - ./dataset:/dataset  # Same bind mount as webapp
    environment:
      - WEBAPP_BASE_URL=http://webapp:8000
      - WORKER_ID=ios-worker-1
      - JOB_TYPE=ios
      - POLL_INTERVAL=60
    depends_on:
      - webapp
      - dataset-init
    restart: unless-stopped
    command: python /app/docker_integration_example.py --job-type ios --worker-id ios-worker-1
    # Alternative: use your existing polling script
    # command: your-existing-ios-polling-script.py

  # Audio/Speech-to-Text Processing Container
  audio-processor:
    image: your-speech-to-text:latest
    volumes:
      - ./dataset:/dataset  # Same bind mount as webapp
    environment:
      - WEBAPP_BASE_URL=http://webapp:8000
      - WORKER_ID=audio-worker-1
      - JOB_TYPE=audio
      - POLL_INTERVAL=60
    depends_on:
      - webapp
      - dataset-init
    restart: unless-stopped
    command: python /app/docker_integration_example.py --job-type audio --worker-id audio-worker-1
    # Alternative: use your existing polling script
    # command: your-existing-audio-polling-script.py

volumes:
  postgres_data:

# Optional: Use a named volume instead of bind mount
# If you prefer to use a Docker managed volume instead of ./dataset bind mount:
#
# volumes:
#   postgres_data:
#   dataset_volume:
#
# Then change the volume mounts to:
#   - dataset_volume:/dataset 