<!-- Vocal Caption Section -->
<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-2" data-bs-toggle="collapse" data-bs-target="#vocalCaptionCollapse" aria-expanded="false" aria-controls="vocalCaptionCollapse" style="cursor: pointer;">
        <h6 class="mb-0"><i class="fas fa-microphone me-2"></i>Voice Captions</h6>
        <i class="fas fa-chevron-right collapse-indicator"></i>
    </div>

    <div class="collapse" id="vocalCaptionCollapse">
        <!-- Hidden CSRF token for AJAX usage -->
        <form style="display:none;">{% csrf_token %}</form>

        <!-- Unified Caption Card (Text + Voice) -->
        <div id="captionUnifiedCard" class="card mb-2">
            <div class="card-body p-2">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <div id="recordingControls" class="d-flex align-items-center">
                        <button type="button" class="btn btn-primary btn-sm" id="startRecording">
                            <i class="fas fa-circle me-1"></i>Record
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm ms-1 d-none" id="pauseRecording" title="Pause">
                            <i class="fas fa-pause"></i>
                        </button>
                        <button type="button" class="btn btn-success btn-sm ms-1 d-none" id="saveRecording">
                            <i class="fas fa-save me-1"></i>Save
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm ms-1 d-none" id="discardRecording">
                            <i class="fas fa-times me-1"></i>Discard
                        </button>
                    </div>
                    <div id="textControls" class="d-flex align-items-center">
                        <small class="text-muted me-2">Characters: <span id="textCharCount">0</span></small>
                        <div>
                            <button type="button" class="btn btn-success btn-sm" id="saveTextCaption">
                                <i class="fas fa-save me-1"></i>Save
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="clearTextCaption">
                                <i class="fas fa-eraser me-1"></i>Clear
                            </button>
                        </div>
                    </div>
                </div>

                <div id="textInputContainer" class="mb-2 position-relative">
                    <textarea id="captionTextArea" class="form-control form-control-sm" rows="4" placeholder="Write your caption here..."></textarea>
                </div>

                <div id="recordingArea" class="d-none">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <div class="recording-info">
                            <small class="text-muted me-2">Modality:</small>
                            <span class="badge bg-secondary" id="modalityIndicator">Voice</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1" style="height: 6px; width: 200px;">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="ms-2" id="recordingTimer">00:00</small>
                        </div>
                    </div>
                    <div class="audio-playback d-none"></div>
                </div>
            </div>
        </div>

        <!-- Captions List -->
        <div class="voice-captions-list">
            {% with captions=scan_pair.voice_captions.all %}
                {% if captions %}
                    <div class="caption-list-compact">
                        {% for c in captions|dictsortreversed:"created_at" %}
                        <div class="caption-item-compact" data-caption-id="{{ c.id }}">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="caption-info">
                                    <small class="text-primary me-2">{{ c.user.username }}</small>
                                    <span class="badge bg-secondary me-2">{{ c.get_modality_display }}</span>
                                    <span class="badge bg-secondary me-2">{{ c.get_display_duration|default:'Audio' }}</span>
                                    <small class="text-muted">{{ c.created_at|date:"M d, H:i" }}</small>
                                </div>
                                <div class="caption-actions">
                                    {% with audio=c.get_audio_file %}
                                        {% if audio %}
                                        <button class="btn btn-outline-primary btn-sm btn-play-audio" data-audio-url="/api/processing/files/serve/{{ audio.id }}/" title="Play">
                                            <i class="fas fa-play" style="font-size: 0.75rem;"></i>
                                        </button>
                                        {% endif %}
                                    {% endwith %}
                                    {% if c.text_caption %}
                                    <button class="btn btn-outline-secondary btn-sm btn-edit-caption" data-caption-id="{{ c.id }}" title="Edit">
                                        <i class="fas fa-edit" style="font-size: 0.75rem;"></i>
                                    </button>
                                    {% endif %}
                                    <button class="btn btn-outline-danger btn-sm btn-delete-caption" data-caption-id="{{ c.id }}" title="Delete">
                                        <i class="fas fa-trash" style="font-size: 0.75rem;"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="caption-text-compact mt-1">
                                {% if c.text_caption %}
                                    <div class="caption-text-display">
                                        <div class="caption-text-preview">
                                            <small class="text-dark">
                                                {{ c.text_caption|truncatechars:100 }}
                                            </small>
                                            {% if c.text_caption|length > 100 %}
                                            <button class="btn btn-link btn-sm p-0 caption-toggle-btn" data-caption-id="{{ c.id }}">
                                                <small class="text-primary">more</small>
                                            </button>
                                            {% endif %}
                                        </div>
                                        {% if c.text_caption|length > 100 %}
                                        <div class="caption-text-full" id="caption-full-{{ c.id }}" style="display: none;">
                                            <small class="text-dark">{{ c.text_caption }}</small>
                                            <button class="btn btn-link btn-sm p-0 caption-toggle-btn" data-caption-id="{{ c.id }}">
                                                <small class="text-primary">less</small>
                                            </button>
                                        </div>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>
                                        {% if c.processing_status == 'completed' %}Ready{% else %}Processing...{% endif %}
                                    </small>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="no-captions">
                        <p class="text-muted mb-0 text-center">
                            <i class="fas fa-comment me-1"></i>
                            No captions yet. Record audio or write text to describe your findings!
                        </p>
                    </div>
                {% endif %}
            {% endwith %}
        </div>

        <!-- Edit Transcription Modal -->
        <div class="modal fade" id="editTranscriptionModal" tabindex="-1" aria-labelledby="editTranscriptionLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editTranscriptionLabel">Edit Transcription</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <textarea id="transcriptionText" class="form-control" rows="6"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" id="revertToOriginal">Revert</button>
                        <button type="button" class="btn btn-primary" id="saveTranscription">Save</button>
                    </div>
                </div>
            </div>
        </div>
        <script>
        document.addEventListener('DOMContentLoaded', function () {
            var textArea = document.getElementById('captionTextArea');
            var textControls = document.getElementById('textControls');
            var recordingArea = document.getElementById('recordingArea');
            var textInputContainer = document.getElementById('textInputContainer');

            var startBtn = document.getElementById('startRecording');
            var pauseBtn = document.getElementById('pauseRecording');
            var saveRecBtn = document.getElementById('saveRecording');
            var discardRecBtn = document.getElementById('discardRecording');

            var charCount = document.getElementById('textCharCount');
            var clearTextBtn = document.getElementById('clearTextCaption');

            function updateCharCount() {
                if (charCount && textArea) {
                    charCount.textContent = textArea.value.length.toString();
                }
            }

            function enterRecordingMode() {
                if (textArea) {
                    textArea.setAttribute('disabled', 'disabled');
                }
                if (textControls) {
                    textControls.classList.add('d-none');
                }
                if (textInputContainer) {
                    textInputContainer.classList.add('d-none');
                }
                if (recordingArea) {
                    recordingArea.classList.remove('d-none');
                }
                if (startBtn) {
                    startBtn.classList.add('d-none');
                }
                if (pauseBtn) {
                    pauseBtn.classList.remove('d-none');
                }
                if (saveRecBtn) {
                    saveRecBtn.classList.remove('d-none');
                }
                if (discardRecBtn) {
                    discardRecBtn.classList.remove('d-none');
                }
            }

            function exitRecordingMode() {
                if (textArea) {
                    textArea.removeAttribute('disabled');
                }
                if (textControls) {
                    textControls.classList.remove('d-none');
                }
                if (textInputContainer) {
                    textInputContainer.classList.remove('d-none');
                }
                if (recordingArea) {
                    recordingArea.classList.add('d-none');
                }
                if (startBtn) {
                    startBtn.classList.remove('d-none');
                }
                if (pauseBtn) {
                    pauseBtn.classList.add('d-none');
                }
                if (saveRecBtn) {
                    saveRecBtn.classList.add('d-none');
                }
                if (discardRecBtn) {
                    discardRecBtn.classList.add('d-none');
                }
            }

            if (startBtn) {
                startBtn.addEventListener('click', function () {
                    enterRecordingMode();
                });
            }
            if (discardRecBtn) {
                discardRecBtn.addEventListener('click', function () {
                    exitRecordingMode();
                });
            }
            if (saveRecBtn) {
                saveRecBtn.addEventListener('click', function () {
                    exitRecordingMode();
                });
            }
            if (clearTextBtn && textArea) {
                clearTextBtn.addEventListener('click', function () {
                    textArea.value = '';
                    updateCharCount();
                });
            }
            if (textArea) {
                textArea.addEventListener('input', updateCharCount);
                updateCharCount();
            }
        });
        </script>
    </div>
</div>

