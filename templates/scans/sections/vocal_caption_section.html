<!-- Vocal Caption Section -->
<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-2" data-bs-toggle="collapse" data-bs-target="#vocalCaptionCollapse" aria-expanded="true" aria-controls="vocalCaptionCollapse" style="cursor: pointer;">
        <h6 class="mb-0"><i class="fas fa-microphone me-2"></i>Vocal Caption</h6>
        <div class="d-flex align-items-center">
            <small class="text-muted me-2">Describe the findings</small>
            <i class="fas fa-chevron-down collapse-indicator"></i>
        </div>
    </div>
    
    <div class="collapse show" id="vocalCaptionCollapse">
        <div class="vocal-caption-section">
            <!-- Audio Recording Interface -->
            <div class="audio-recorder-card mb-3">
                <div class="recorder-controls-new">
                    <button type="button" class="btn btn-primary btn-record-round" id="startRecording">
                        <i class="fas fa-microphone"></i>
                    </button>
                    
                    <div class="recording-info d-none" id="recordingInfo">
                        <div class="recording-modality">
                            <small class="text-muted">
                                <i class="fas fa-circle recording-pulse me-1"></i>
                                Recording <span id="modalityIndicator">CBCT</span> annotation
                            </small>
                        </div>
                        <div class="recording-controls-inline">
                            <div class="recording-timer">
                                <span id="recordingTimer">00:00</span>
                            </div>
                            <div class="progress-container">
                                <div class="progress">
                                    <div class="progress-bar" id="recordingProgress" role="progressbar"></div>
                                </div>
                            </div>
                            <div class="action-buttons">
                                <button type="button" class="btn btn-warning btn-round-sm" id="pauseRecording" title="Pause">
                                    <i class="fas fa-pause"></i>
                                </button>
                                <button type="button" class="btn btn-success btn-round-sm" id="saveRecording" title="Save">
                                    <i class="fas fa-save"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-round-sm" id="discardRecording" title="Discard">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <audio id="audioPlayback" class="d-none" controls></audio>
            </div>
            
            <!-- Existing Voice Captions - Compact List -->
            <div class="voice-captions-list">
                {% if scan_pair.voice_captions.exists %}
                    <div class="caption-list-compact">
                        {% for caption in scan_pair.voice_captions.all %}
                            <div class="caption-item-compact" data-caption-id="{{ caption.id }}">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="caption-info">
                                        <small class="text-primary me-2">{{ caption.user.username }}</small>
                                        <span class="badge bg-secondary me-1">{{ caption.get_modality_display }}</span>
                                        <span class="badge bg-{{ caption.get_quality_status.color }} me-2">{{ caption.get_display_duration }}</span>
                                        <small class="text-muted">{{ caption.created_at|date:"M d, H:i" }}</small>
                                    </div>
                                    <div class="caption-actions">
                                        {% if caption.get_audio_file %}
                                        <button class="btn btn-outline-primary btn-sm btn-play-audio" data-audio-url="/api/processing/files/serve/{{ caption.get_audio_file.id }}/" title="Play">
                                            <i class="fas fa-play" style="font-size: 0.75rem;"></i>
                                        </button>
                                        {% endif %}
                                        {% if caption.is_processed and caption.text_caption and user_profile.is_annotator or caption.user == request.user %}
                                        <button class="btn btn-outline-secondary btn-sm btn-edit-caption" data-caption-id="{{ caption.id }}" title="Edit">
                                            <i class="fas fa-edit" style="font-size: 0.75rem;"></i>
                                        </button>
                                        {% endif %}
                                        {% if user_profile.is_annotator or caption.user == request.user %}
                                        <button class="btn btn-outline-danger btn-sm btn-delete-caption" data-caption-id="{{ caption.id }}" title="Delete">
                                            <i class="fas fa-trash" style="font-size: 0.75rem;"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="caption-text-compact mt-1">
                                    {% if caption.processing_status == 'processing' %}
                                        <small class="text-muted">
                                            <i class="fas fa-spinner fa-spin me-1"></i>
                                            Converting speech to text...
                                        </small>
                                    {% elif caption.processing_status == 'failed' %}
                                        <small class="text-muted">
                                            <i class="fas fa-exclamation-triangle me-1 text-danger"></i>
                                            Processing failed
                                        </small>
                                    {% elif caption.is_processed and caption.text_caption %}
                                        <div class="caption-text-display">
                                            <div class="caption-text-preview">
                                                <small class="text-dark">
                                                    {{ caption.text_caption|truncatechars:100 }}
                                                    {% if caption.is_edited %}
                                                        <span class="badge bg-warning ms-1" title="Edited transcription">edited</span>
                                                    {% endif %}
                                                </small>
                                                {% if caption.text_caption|length > 100 %}
                                                    <button class="btn btn-link btn-sm p-0 caption-toggle-btn" 
                                                            data-caption-id="{{ caption.id }}">
                                                        <small class="text-primary">more</small>
                                                    </button>
                                                {% endif %}
                                            </div>
                                            <div class="caption-text-full" id="caption-full-{{ caption.id }}" style="display: none;">
                                                <small class="text-dark">
                                                    {{ caption.text_caption }}
                                                    {% if caption.is_edited %}
                                                        <span class="badge bg-warning ms-1" title="Edited transcription">edited</span>
                                                    {% endif %}
                                                </small>
                                                <button class="btn btn-link btn-sm p-0 caption-toggle-btn" 
                                                        data-caption-id="{{ caption.id }}">
                                                    <small class="text-primary">less</small>
                                                </button>
                                            </div>
                                        </div>
                                    {% else %}
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>
                                            Preprocessing audio...
                                        </small>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="no-captions">
                        <p class="text-muted mb-0 text-center">
                            <i class="fas fa-microphone me-1"></i>
                            No voice captions yet. Click the record button to start!
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Edit Transcription Modal -->
<div class="modal fade" id="editTranscriptionModal" tabindex="-1" aria-labelledby="editTranscriptionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editTranscriptionModalLabel">
                    <i class="fas fa-edit me-2"></i>Edit Transcription
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editTranscriptionForm">
                    <div class="mb-3">
                        <label for="transcriptionText" class="form-label">Transcription Text</label>
                        <textarea class="form-control" id="transcriptionText" rows="6" required></textarea>
                        <div class="form-text">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                This will override the original transcription. The original will be preserved and can be restored if needed.
                            </small>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="editHistorySection" style="display: none;">
                        <label class="form-label">Edit History</label>
                        <div class="edit-history-list" id="editHistoryList">
                            <!-- Edit history will be populated here -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="revertToOriginal" style="display: none;">
                    <i class="fas fa-undo me-1"></i>Revert to Original
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveTranscription">
                    <i class="fas fa-save me-1"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div> 