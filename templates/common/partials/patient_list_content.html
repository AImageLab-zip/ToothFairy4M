{% load pagination_tags %}
<!-- Hidden CSRF token for AJAX usage -->
<form style="display:none;">{% csrf_token %}</form>

    <div class="row align-items-center mb-3">
        <div class="col-12 col-lg-10 offset-lg-2">
            <h4 class="mb-0"><i class="fas fa-users me-2"></i>List of Patients</h4>
        </div>
    </div>

    <div class="row patient-page g-3">
        <aside class="sidebar-col col-12 col-lg-2">
            <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong><i class="fas fa-folder-tree me-2"></i>Folders</strong>
                    <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#folderTreeCollapse" aria-expanded="true" aria-controls="folderTreeCollapse" title="Collapse folders" data-bs-toggle-tooltip>
                        <i class="fas fa-chevron-up"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="folder-item {% if folder_id == 'all' %}active{% endif %}" data-folder="all">
                        <a href="?folder=all" class="text-decoration-none text-reset">
                            <i class="fas fa-folder-open text-warning me-2"></i>Show All
                        </a>
                    </div>
                    <div id="folderTreeCollapse" class="collapse show">
                        <div id="folderTree">
                        {% for f in folders %}
                        <div class="folder-node" data-id="{{ f.folder.id }}">
                            <div class="folder-item {% if folder_id|add:'' == f.folder.id|add:'' %}active{% endif %}" data-folder="{{ f.folder.id }}">
                                <a href="?folder={{ f.folder.id }}" class="text-decoration-none text-reset">
                                    <i class="fas fa-folder text-warning me-2"></i>{{ f.folder.name }}
                                    <span class="badge bg-secondary ms-2">{{ f.patient_count }}</span>
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                        </div>
                    </div>
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-primary w-100" id="btnCreateFolder"><i class="fas fa-plus me-1"></i>New Folder</button>
                    </div>
                </div>
            </div>
            <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong><i class="fas fa-filter me-2"></i>Filters</strong>
                    <button id="filtersCollapseToggle" class="btn btn-sm btn-outline-secondary collapse-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse" aria-expanded="true" aria-controls="filtersCollapse" title="Collapse filters" data-bs-toggle-tooltip>
                        <i class="fas fa-chevron-up"></i>
                    </button>
                </div>
                <div id="filtersCollapse" class="collapse show card-body sidebar-filters">
                    <div class="filter-section">
                        <form id="filterForm">
                            <div class="filter-row">
                                <div class="filter-item">
                                    <label class="filter-label">Search</label>
                                    <input type="text" class="filter-input" name="search" placeholder="Search by name or ID" value="{{ search_query }}">
                                </div>
                                <div class="filter-item">
                                    <label class="filter-label">Modalities</label>
                                    <div class="status-filter-buttons">
                                        <input type="hidden" id="iosFilterValue" name="has_ios" value="{{ has_ios_filter }}">
                                        <input type="hidden" id="cbctFilterValue" name="has_cbct" value="{{ has_cbct_filter }}">
                                        <input type="hidden" id="biteFilterValue" name="has_bite" value="{{ has_bite_filter }}">
                                        <input type="hidden" id="voiceFilterValue" name="has_voice" value="{{ has_voice_filter }}">
                                        {% for m in modality_filter_specs %}
                                        <input type="hidden" id="status_{{ m.slug }}_value" name="status_{{ m.slug }}" value="{{ m.value }}">
                                        <button type="button" class="status-filter-btn" data-filter="status_{{ m.slug }}" title="All {{ m.name }} (no filter)" data-bs-toggle="tooltip">
                                            {% if m.icon %}
                                            <i class="{{ m.icon }}"></i>
                                            {% else %}
                                            <span class="status-filter-label">{{ m.label|default:m.name }}</span>
                                            {% endif %}
                                        </button>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="filter-item">
                                    <label class="filter-label">Per page</label>
                                    <select name="per_page" class="filter-select">
                                        <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                                        <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                                        <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                                        <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                                    </select>
                                </div>
                                <div class="filter-item filter-actions">
                                    <button type="submit" class="btn btn-primary uniform-btn">Apply Filters</button>
                                    <a class="btn btn-outline-secondary uniform-btn" href="?">Reset</a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="card mt-3" id="bulkToolbarCard">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong><i class="fas fa-layer-group me-2"></i>Bulk actions</strong>
                    <button id="bulkCollapseToggle" class="btn btn-sm btn-outline-secondary collapse-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#bulkCollapse" aria-expanded="true" aria-controls="bulkCollapse" title="Collapse bulk actions" data-bs-toggle-tooltip>
                        <i class="fas fa-chevron-up"></i>
                    </button>
                </div>
                <div id="bulkCollapse" class="collapse show card-body">
                    <div class="bulk-toolbar d-flex align-items-center justify-content-between" id="bulkToolbar">
                        <div class="d-flex align-items-center gap-2">
                            <span class="text-muted small" id="selectedCount">0 selected</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <label for="moveFolderSelect" class="me-1 mb-0 small text-muted">Move to folder:</label>
                            <select id="moveFolderSelect" class="form-select form-select-sm" aria-label="Move to folder">
                                <option value="" selected>Chooseâ€¦</option>
                                <option value="all">Remove from folder</option>
                                {% for f in folders %}
                                <option value="{{ f.folder.id }}">{{ f.folder.name }}</option>
                                {% endfor %}
                            </select>
                            <button id="btnMoveSelected" class="btn btn-primary btn-sm uniform-btn" title="Move to folder" data-bs-toggle="tooltip" aria-label="Move to folder">
                                <i class="fas fa-folder-open"></i><span class="btn-label ms-1">Move</span>
                            </button>
                            <button id="btnDeleteSelected" class="btn btn-danger btn-sm uniform-btn" title="Delete selected" data-bs-toggle="tooltip" aria-label="Delete selected">
                                <i class="fas fa-trash"></i><span class="btn-label ms-1">Delete</span>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary uniform-btn" id="btnClearSelection" title="Clear selection" data-bs-toggle="tooltip" aria-label="Clear selection">
                                <i class="fas fa-times"></i><span class="btn-label ms-1">Clear</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
        <main class="main-col col-12 col-lg-8">
    <div class="patient-list-wrapper">

    
    <div class="patient-list">
        <div class="patient-list-header">
            <div class="col-check">
                <input type="checkbox" id="selectAll">
            </div>
            <div>Patient</div>
            <div>Modalities</div>
            <div>Tags</div>
            <div>Uploader</div>
            <div>Privacy</div>
            <div>Actions</div>
        </div>
        {% for item in page_obj.object_list %}
        {% with p=item.patient %}
        <div class="patient-row" data-scan-id="{{ p.patient_id }}">
            <div class="col-check">
                <input type="checkbox" class="row-select" value="{{ p.patient_id }}">
            </div>
            <div class="scan-name">
                <a class="scan-name-text" href="{% url request.resolver_match.namespace|add:':patient_detail' p.patient_id %}" title="Open patient" data-bs-toggle="tooltip" aria-label="Open patient">{{ p.name|default:'Unnamed' }}</a>
                <small class="text-muted d-block">ID: {{ p.patient_id }}</small>
                {% if user_profile.is_admin %}
                <button class="btn btn-sm btn-outline-secondary p-0 px-1 btn-edit-name-list" data-scan-id="{{ p.patient_id }}" title="Rename" data-bs-toggle="tooltip" aria-label="Rename">
                    <i class="fas fa-edit"></i>
                </button>
                {% endif %}
            </div>
            
            <div class="processing-status">
                <div class="status-indicators">
                    {% for ms in item.modality_status_list %}
                    {% if ms.slug != 'voice' %}
                    <span class="badge rounded-pill me-1 status-pill status-{{ ms.status }}" title="{{ ms.name }}" data-bs-toggle="tooltip" aria-label="{{ ms.name }}">{% if ms.icon %}<i class="{{ ms.icon }}"></i>{% else %}{{ ms.label|default:ms.name }}{% endif %}</span>
                    {% endif %}
                    {% endfor %}
                    <span class="badge rounded-pill me-1 status-pill {% if item.voice_caption_processing %}status-processing{% elif item.voice_caption_processed %}status-processed{% else %}status-absent{% endif %}" title="Voice" data-bs-toggle="tooltip" aria-label="Voice"><i class="fas fa-comment"></i></span>
                </div>
            </div>
            <div class="tags-col">
                {% if p.tags.all %}
                    {% for t in p.tags.all %}
                        <span class="tag-badge" data-tag="{{ t.name }}">
                            {{ t.name }}
                            <button type="button" class="btn-remove-tag-inline" data-scan-id="{{ p.patient_id }}" data-tag="{{ t.name }}" title="Remove tag">&times;</button>
                        </span>
                    {% empty %}
                        <small class="text-muted">-</small>
                    {% endfor %}
                {% else %}
                    <small class="text-muted">-</small>
                {% endif %}
                <button class="btn btn-sm btn-outline-secondary p-0 ms-1 btn-add-tag" data-scan-id="{{ p.patient_id }}" title="Add tag">
                    <i class="fas fa-plus" style="font-size: 0.65rem;"></i>
                </button>
            </div>
            <div class="uploader">
                {% if p.uploaded_by %}
                    <span class="uploader-name">{{ p.uploaded_by.username }}</span>
                {% else %}
                    <small class="text-muted">-</small>
                {% endif %}
            </div>
            <div class="privacy">
                <span class="privacy-badge privacy-{{ p.visibility }}">{{ p.visibility|capfirst }}</span>
            </div>
            <div class="actions">
                <div class="btn-group btn-group-sm" role="group">
                    <a href="{% url request.resolver_match.namespace|add:':patient_detail' p.patient_id %}" class="btn btn-outline-primary btn-open" title="View" data-bs-toggle="tooltip" aria-label="View"><i class="fas fa-eye"></i>
                    </a>
                    {% if user_profile.is_admin %}
                    <button class="btn btn-outline-secondary btn-rerun-processing" data-scan-id="{{ p.patient_id }}" data-scan-name="{{ p.name|default:'Scan' }}" title="Rerun processing" data-bs-toggle="tooltip" aria-label="Rerun"><i class="fas fa-sync"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-delete-scan" data-scan-id="{{ p.patient_id }}" data-scan-name="{{ p.name|default:'Scan' }}" data-patient-id="{{ p.patient_id }}" title="Delete" data-bs-toggle="tooltip" aria-label="Delete"><i class="fas fa-trash"></i>
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endwith %}
        {% endfor %}
    </div>
    
    <div class="patient-list-footer mt-2">
        <nav aria-label="Page navigation">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <ul class="pagination pagination-sm mb-0">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="{% pagination_url page_obj.previous_page_number %}" aria-label="Previous">
                            <i class="fas fa-chevron-left"></i> Previous
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link"><i class="fas fa-chevron-left"></i> Previous</span>
                    </li>
                    {% endif %}
                    
                    <li class="page-item disabled">
                        <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
                    </li>
                    
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{% pagination_url page_obj.next_page_number %}" aria-label="Next">
                            Next <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">Next <i class="fas fa-chevron-right"></i></span>
                    </li>
                    {% endif %}
                </ul>
                
                {% if page_obj.paginator.num_pages > 1 %}
                <div class="d-flex align-items-center gap-2">
                    <small class="text-muted">Jump to page:</small>
                    <form method="get" class="d-flex align-items-center gap-1" onsubmit="return handlePageJumpSubmit(event, {{ page_obj.paginator.num_pages }})">
                        {% for key, value in request.GET.items %}
                            {% if key != 'page' %}
                            <input type="hidden" name="{{ key }}" value="{{ value }}">
                            {% endif %}
                        {% endfor %}
                        <input type="number" 
                               name="page" 
                               class="form-control form-control-sm" 
                               style="width: 70px;" 
                               placeholder="#" 
                               min="1" 
                               max="{{ page_obj.paginator.num_pages }}"
                               title="Enter page number (1-{{ page_obj.paginator.num_pages }})"
                               aria-label="Page number">
                        <button type="submit" class="btn btn-sm btn-primary" title="Go to page">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
        </nav>
    </div>

    </div><!-- /.patient-list-wrapper -->
        </main>
    </div>


<div class="modal fade" id="rerunProcessingModal" tabindex="-1" aria-labelledby="rerunProcessingModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rerunProcessingModalLabel">Rerun processing</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2"><small class="text-muted" id="rerunScanSubtitle"></small></div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="ios" id="rerunIos">
          <label class="form-check-label" for="rerunIos">IOS processing</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="bite_classification" id="rerunBite">
          <label class="form-check-label" for="rerunBite">Bite classification</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="cbct" id="rerunCbct">
          <label class="form-check-label" for="rerunCbct">CBCT</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="voice" id="rerunVoice">
          <label class="form-check-label" for="rerunVoice">All voice transcriptions</label>
        </div>
        <div class="mt-2"><small class="text-muted">This will set existing jobs to pending. No new jobs will be created.</small></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmRerunBtn">
          <span class="label">Rerun selected</span>
          <span class="spinner d-none"><i class="fas fa-spinner fa-spin"></i></span>
        </button>
      </div>
    </div>
  </div>
    </div>

